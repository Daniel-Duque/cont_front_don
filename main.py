#Original From Daniel Duque Lozano
# -*- coding: utf-8 -*-
"""analisis_territorial.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1AQnWOCqJUWkHUKJg-HgLbDXsLa72uWoS
"""


import pandas as pd
import os
import plotly.express as px
import matplotlib.pyplot as plt
from plotly.subplots import make_subplots
import plotly.graph_objs as go
import geopandas as gp
import seaborn
import streamlit as st

st.set_page_config(layout='wide')


filtrado1=pd.read_csv(r"data/dicc/Ciudades.csv").sort_values(["Departamento Entidad","Ciudad Entidad"],ascending=False)

extrange="Tamaño valor extraño"


st.title("Banderas rojas contratación pública (valores en millones de pesos")

tab0,tab1,tab2,tab3 = st.tabs(['selección','mapas :D',"prediction quality","ingresos"])
with tab0:
    
    
    depto=st.selectbox("Departamento Entidad",
                       pd.unique(filtrado1["Departamento Entidad"]))
    

    resulting=filtrado1[filtrado1["Departamento Entidad"]==depto]
    
    muni = st.selectbox("Ciudad Entidad",
       pd.unique(resulting["Ciudad Entidad"]))    
    
  
    
    resulting=pd.read_csv(r"data/particular/"+depto+"-"+muni+".csv")
    
    resulting=resulting[["Entidad","Descripción del Procedimiento","Tipo de Contrato",
                         "Valor real","Valor Proyectado",extrange,"Similitud de valor",
                         "veces la predicción"]]      

    resulting=resulting.sort_values("veces la predicción",ascending=False)
    
    st.dataframe(resulting.style.background_gradient(axis=None, cmap="Reds"))
    
agroupados=pd.read_csv(r"data/grouped.csv")
df = gp.read_file(r"data/maps/MGN_MPIO_POLITICO.shp") 
df=df.merge(agroupados, how="left",left_on=["MPIO_CNMBR","DPTO_CNMBR"],
            right_on=["Ciudad Entidad","Departamento Entidad"])    


    
with tab1:
    depto=st.selectbox("Departamento Entidad",
                       pd.unique(filtrado1["Departamento Entidad"]),key=1)
    

    resulting=filtrado1[filtrado1["Departamento Entidad"]==depto]
    
  
    submap=df[df["DPTO_CNMBR"]==depto]    

    fig = px.choropleth(submap, geojson=submap.geometry, locations=submap.index,
                        color=submap["Tamaño valor extraño"], color_continuous_scale='inferno_r')
    fig.update_geos(fitbounds="locations", visible=False)
    st.plotly_chart(fig)
    
with tab2:

    seaborn.histplot(df[["Valor real","Valor Proyectado"]],x="predict",y="value_million_dolar",cbar=True,bins=1000)
    
    
    